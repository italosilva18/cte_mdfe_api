{% extends "base.html" %}
{% load static %}

{% block title %}Upload de XML{% endblock %}
{% block header %}Upload de Documentos XML{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item active" aria-current="page">Upload</li>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row g-4">

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header text-white" style="background-color: var(--verde-primario);">
                    <h5 class="card-title mb-0"><i class="fas fa-file-upload me-2"></i>Upload Individual ou Evento</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <form id="uploadForm" name="uploadForm" class="needs-validation flex-grow-1 d-flex flex-column" novalidate>
                        {% csrf_token %}

                        <div class="mb-3 file-drop-zone" id="dropZonePrincipal">
                            <label for="arquivo_xml" class="form-label">
                                <i class="fas fa-cloud-upload-alt fa-2x text-secondary mb-2"></i><br>
                                Arraste o XML principal aqui ou clique para selecionar
                            </label>
                            <input type="file" class="form-control file-input-hidden" id="arquivo_xml" name="arquivo_xml" accept=".xml" required aria-describedby="arquivoPrincipalHelp">
                             <div id="fileInfoPrincipal" class="mt-2 text-muted small"></div> {# Para mostrar nome do arquivo #}
                             <div class="invalid-feedback">Por favor, selecione um arquivo XML.</div>
                            <small id="arquivoPrincipalHelp" class="form-text text-muted">Necessário para CT-e, MDF-e ou Evento.</small>
                        </div>


                        <div class="mb-3 file-drop-zone" id="dropZoneRetorno">
                             <label for="arquivo_xml_retorno" class="form-label">
                                <i class="fas fa-reply fa-2x text-secondary mb-2"></i><br>
                                Arraste o XML de Retorno (opcional) ou clique
                            </label>
                            <input type="file" class="form-control file-input-hidden" id="arquivo_xml_retorno" name="arquivo_xml_retorno" accept=".xml" aria-describedby="arquivoRetornoHelp">
                             <div id="fileInfoRetorno" class="mt-2 text-muted small"></div> {# Para mostrar nome do arquivo #}
                            <small id="arquivoRetornoHelp" class="form-text text-muted">Usado principalmente para Eventos (retorno da SEFAZ).</small>
                        </div>

                        <button type="button" class="btn btn-sm btn-outline-secondary mb-3 align-self-start" id="btnClearSingle">
                             <i class="fas fa-times me-1"></i> Limpar Seleção
                         </button>

                        <div class="alert alert-danger d-none mt-3" id="uploadError" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span id="errorMessage"></span>
                        </div>
                        <div class="alert alert-success d-none mt-3" id="uploadSuccess" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="successMessage"></span>
                        </div>
                        <div class="progress mt-3 d-none" style="height: 25px;" id="uploadProgress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>

                        <div class="mt-auto pt-3"> {# Garante que o botão fique no final #}
                            <button class="btn btn-success w-100" type="submit" id="btnSubmit">
                                <i class="fas fa-paper-plane me-2"></i>Enviar Arquivo Único
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header text-white" style="background-color: var(--verde-primario);">
                    <h5 class="card-title mb-0"><i class="fas fa-folder-plus me-2"></i>Upload em Lote</h5>
                </div>
                 <div class="card-body d-flex flex-column">
                     <form id="batchUploadForm" name="batchUploadForm" class="needs-validation flex-grow-1 d-flex flex-column" novalidate>
                         {% csrf_token %}

                         <div class="mb-3 file-drop-zone" id="dropZoneBatch">
                            <label for="arquivos_xml_batch" class="form-label">
                                <i class="fas fa-copy fa-2x text-secondary mb-2"></i><br>
                                Arraste múltiplos arquivos XML aqui ou clique para selecionar
                            </label>
                            <input type="file" class="form-control file-input-hidden" id="arquivos_xml_batch" name="arquivos_xml" accept=".xml" multiple required aria-describedby="arquivosBatchHelp">
                             <div id="fileInfoBatch" class="mt-2 text-muted small"></div> {# Para mostrar nomes dos arquivos #}
                             <div class="invalid-feedback">Por favor, selecione um ou mais arquivos XML.</div>
                             <small id="arquivosBatchHelp" class="form-text text-muted">Envie vários CT-es ou MDF-es de uma vez.</small>
                        </div>

                         <button type="button" class="btn btn-sm btn-outline-secondary mb-3 align-self-start" id="btnClearBatch">
                             <i class="fas fa-times me-1"></i> Limpar Seleção
                         </button>

                         <div class="alert alert-danger d-none mt-3" id="batchError" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span id="batchErrorMessage"></span>
                         </div>
                         <div class="alert alert-success d-none mt-3" id="batchSuccess" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="batchSuccessMessage"></span>
                         </div>
                         <div class="progress mt-3 d-none" style="height: 25px;" id="batchProgress">
                             <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                         </div>
                         <div id="batchResultSummary" class="mt-2 small text-muted"></div> {# Resumo do lote #}
                         <div id="batchResultDetails" class="mt-2 small" style="max-height: 150px; overflow-y: auto;"></div> {# Detalhes do lote #}


                         <div class="mt-auto pt-3"> {# Garante que o botão fique no final #}
                            <button class="btn btn-primary w-100" type="submit" id="btnSubmitBatch">
                                <i class="fas fa-boxes me-2"></i>Enviar Arquivos em Lote
                            </button>
                        </div>
                     </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header text-white" style="background-color: var(--verde-primario);">
                     <h5 class="card-title mb-0"><i class="fas fa-history me-2"></i>Histórico Recente</h5>
                </div>
                <div class="card-body p-0">
                     <div class="table-responsive">
                         <table class="table table-striped table-hover mb-0">
                             <thead class="table-light">
                                 <tr>
                                     <th>Data/Hora Upload</th>
                                     <th>Tipo</th>
                                     <th>Chave (Início/Fim)</th>
                                     <th>Status</th>
                                     <th>Ações</th>
                                 </tr>
                             </thead>
                             <tbody id="upload-history">
                                 <tr>
                                     <td colspan="5" class="text-center p-4">
                                         <div class="spinner-border spinner-border-sm text-secondary me-2" role="status">
                                             <span class="visually-hidden">Carregando...</span>
                                         </div>
                                         Carregando histórico...
                                     </td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                </div>
                 <div class="card-footer text-center">
                    <button class="btn btn-sm btn-outline-secondary" id="refreshHistoryBtn">
                        <i class="fas fa-sync-alt me-1"></i> Atualizar Histórico
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{# Estilos específicos para a drop zone #}
<style>
    .file-drop-zone {
        border: 2px dashed #ccc;
        border-radius: .375rem; /* Equivalente a Bootstrap .rounded */
        padding: 2rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        position: relative; /* Para o input escondido */
        background-color: #f8f9fa; /* Cor de fundo leve */
    }
    .file-drop-zone:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }
    .file-drop-zone.dragover { /* Classe a ser adicionada via JS */
        background-color: var(--verde-claro);
        border-color: var(--verde-secundario);
    }
    .file-drop-zone label {
        cursor: pointer;
        display: block; /* Garante que o label ocupe a área */
    }
    .file-input-hidden {
        /* Esconde o input default, mas o mantém funcional */
        opacity: 0;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block scripts %}
{# Adiciona o script de upload que agora precisa lidar com a nova estrutura #}
<script src="{% static 'js/upload.js' %}"></script>
{# Adiciona um novo script para a lógica do upload em lote #}
<script src="{% static 'js/upload_batch.js' %}"></script>
{% endblock %}