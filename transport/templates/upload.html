{% extends "base.html" %}
{% load static %}

{% block title %}Upload de XML{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-sm mb-4">
                <div class="card-header text-white" style="background-color: var(--verde-primario);">
                    <h4 class="card-title mb-0"><i class="fas fa-upload me-2"></i>Upload de XML</h4>
                </div>
                <div class="card-body">
                    <form id="uploadForm" class="needs-validation" novalidate>
                        {% csrf_token %} {# Adicionar CSRF token se necessário para views não-API #}

                        {# Campo Removido pois a detecção automática é a única opção na view UnifiedUploadViewSet #}
                        {# <div class="mb-3">
                            <label for="tipoUpload" class="form-label">Tipo de Upload</label>
                            <select class="form-select" id="tipoUpload">
                                <option value="auto" selected>Detectar Automaticamente</option>
                                <option value="cte">CT-e / CTeProc</option>
                                <option value="mdfe">MDF-e / MDFeProc</option>
                                <option value="evento">Evento (Cancelamento, Encerramento, etc.)</option>
                            </select>
                            <div class="form-text">O sistema tentará detectar automaticamente o tipo de documento.</div>
                        </div> #}

                        <div class="mb-3">
                            <label for="arquivo_xml" class="form-label">Arquivo XML Principal</label>
                            <input type="file" class="form-control" id="arquivo_xml" name="arquivo_xml" accept=".xml" required>
                            <div class="invalid-feedback">
                                Por favor, selecione um arquivo XML.
                            </div>
                        </div>

                        <div class="mb-3" id="retornoGroup">
                            <label for="arquivo_xml_retorno" class="form-label">Arquivo XML de Retorno <span class="text-muted">(opcional)</span></label>
                            <input type="file" class="form-control" id="arquivo_xml_retorno" name="arquivo_xml_retorno" accept=".xml">
                            <div class="form-text">Necessário apenas para alguns eventos (Ex: XML do evento + XML do retorno da SEFAZ).</div>
                        </div>

                        <div class="alert alert-info" id="eventoInfo">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Importante:</strong> Para processar eventos (Cancelamento, Encerramento, etc.),
                            o documento principal (CT-e ou MDF-e) já deve existir no sistema.
                        </div>

                        <div class="alert alert-danger d-none" id="uploadError" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span id="errorMessage"></span>
                        </div>
                        <div class="alert alert-success d-none" id="uploadSuccess" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="successMessage"></span>
                        </div>

                        <div class="progress mb-3 d-none" style="height: 25px;" id="uploadProgress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" type="submit" id="btnSubmit">
                                <i class="fas fa-upload me-2"></i>Enviar Arquivo
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card-footer text-muted">
                    <div class="row">
                        <div class="col-6">
                            <small>Tipos Suportados: <strong>CT-e, MDF-e, Eventos</strong></small>
                        </div>
                        <div class="col-6 text-end">
                            <small>Tamanho Máx.: <strong>10 MB</strong></small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header text-white" style="background-color: var(--verde-primario);">
                     <h5 class="card-title mb-0"><i class="fas fa-history me-2"></i>Histórico Recente</h5>
                </div>
                <div class="card-body p-0">
                     <div class="table-responsive">
                         <table class="table table-striped table-hover mb-0">
                             <thead class="table-light">
                                 <tr>
                                     <th>Data/Hora Upload</th>
                                     <th>Tipo</th>
                                     <th>Chave (Início/Fim)</th>
                                     <th>Status</th>
                                     <th>Ações</th>
                                 </tr>
                             </thead>
                             <tbody id="upload-history">
                                 <tr>
                                     <td colspan="5" class="text-center">Carregando histórico...</td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                </div>
                 <div class="card-footer text-center">
                    <button class="btn btn-sm btn-outline-secondary" onclick="UploadXML.refreshHistory()">
                        <i class="fas fa-sync-alt me-1"></i> Atualizar Histórico
                    </button>
                </div>
            </div>

            {# Bloco de Resultado Removido - Feedback agora via Alertas/Toasts e Histórico #}
            {# <div class="card mt-4" id="resultadoCard" style="display: none;"> ... </div> #}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{# Assume que Auth está em base.html ou scripts.js #}
<script src="{% static 'js/upload.js' %}"></script>
{% endblock %}